     1                                  ; hello-os
     2                                  
     3                                  CYLS EQU 10
     4                                  
     5                                      ORG 0x7c00
     6                                  
     7                                  ; 以下は標準的なFAT12フォーマットフロッピーディスクのための記述
     8 00000000 EB4E                        JMP   entry
     9 00000002 90                          DB    0x90
    10 00000003 48415249424F5445            DB    "HARIBOTE"    ; ブートセレクタの名前を自由に書いてよい (8Byte)
    11 0000000B 0002                        DW    512           ; 1セクタの大きさ (512にしなければならない)
    12 0000000D 01                          DB    1             ; クラスタの大きさ (1セクタにしなければならない)
    13 0000000E 0100                        DW    1             ; FATがどこから始まるか (普通は1セクタ目からにする)
    14 00000010 02                          DB    2             ; FATの個数 (2にしなければならない)
    15 00000011 E000                        DW    224           ; ルートディレクトリ領域の大きさ (普通は224エントリにする)
    16 00000013 400B                        DW    2880          ; このドライブの大きさ (2880セクタにしなければならない)
    17 00000015 F0                          DB    0xf0          ; メディアタイプ (0xf0にしなければならない)
    18 00000016 0900                        DW    9             ; FAT領域の長さ (9セクタにしなければならない)
    19 00000018 1200                        DW    18            ; 1トラックにいくつのセクタがあるか (18にしなければならない)
    20 0000001A 0200                        DW    2             ; ヘッドの数 (2にしなければならない)
    21 0000001C 00000000                    DD    0             ; パーティションを使っていないのでここは必ず0
    22 00000020 400B0000                    DD    2880          ; このドライブの大きさをもう一度書く
    23 00000024 000029                      DB    0, 0, 0x29    ; よくわからないけどこの値にしておくといいらしい
    24 00000027 FFFFFFFF                    DD    0xffffffff    ; たぶんボリュームシリアル番号
    25 0000002B 48415249424F54452D-         DB    "HARIBOTE-OS" ; ディスクの名前 (11Byte)
    25 00000034 4F53               
    26 00000036 4641543132202020            DB    "FAT12   "    ; フォーマットの名前 (8Byte)
    27 0000003E 00<rep 12h>                 TIMES 18 DB 0       ; とりあえず18バイト開けておく
    28                                  
    29                                  ; プログラム本体
    30                                  
    31                                  entry:
    32                                  ; レジスタ初期化
    33 00000050 B80000                      MOV AX, 0
    34 00000053 8ED0                        MOV SS, AX
    35 00000055 BC007C                      MOV SP, 0x7c00
    36 00000058 8ED8                        MOV DS, AX
    37                                  
    38                                  ; ディスクを読む
    39 0000005A B82008                      MOV AX, 0x0820
    40 0000005D 8EC0                        MOV ES, AX     ;
    41 0000005F BB0000                      MOV BX, 0      ; ES:BX=0x8200
    42 00000062 B500                        MOV CH, 0      ; シリンダ
    43 00000064 B600                        MOV DH, 0      ; ヘッド
    44 00000066 B102                        MOV CL, 2      ; セクタ
    45                                  readloop:
    46 00000068 BE0000                      MOV SI, 0 ; SI=失敗回数
    47                                  retry:
    48 0000006B B402                        MOV AH, 0x02 ; AH=0x02: ディスク読み込み
    49 0000006D B001                        MOV AL, 1    ; 1セクタ
    50 0000006F B200                        MOV DL, 0x00 ; Aドライブ
    51 00000071 CD13                        INT 0x13     ; ディスクBIOS呼び出し
    52 00000073 7310                        JNC next     ; if no error: goto next
    53 00000075 83C601                      ADD SI, 1
    54 00000078 83FE05                      CMP SI, 5
    55 0000007B 7332                        JAE error    ; if SI >= 5: goto error
    56 0000007D B400                        MOV AH, 0x00 ; エラーコード消去
    57 0000007F B200                        MOV DL, 0x00 ;Aドライブ
    58 00000081 CD13                        INT 0x13     ;ドライブのリセット
    59 00000083 EBE6                        JMP retry
    60                                  next:
    61 00000085 8CC0                        MOV AX, ES
    62 00000087 83C020                      ADD AX, 0x20
    63 0000008A 8EC0                        MOV ES, AX   ; ES+=0x20
    64 0000008C 80C101                      ADD CL, 1
    65 0000008F 80F912                      CMP CL, 18
    66 00000092 76D4                        JBE readloop ; if CL <= 18: goto readloop
    67 00000094 B101                        MOV CL, 1
    68 00000096 80C601                      ADD DH, 1
    69 00000099 80FE02                      CMP DH, 2
    70 0000009C 72CA                        JB  readloop ; if DH < 2: goto readloop
    71 0000009E B600                        MOV DH, 0
    72 000000A0 80C501                      ADD CH, 1
    73 000000A3 80FD0A                      CMP CH, CYLS
    74 000000A6 72C0                        JB  readloop ; if CH < CYLS: goto readloop
    75                                  
    76 000000A8 882EF00F                    MOV [0x0ff0], CH
    77 000000AC E9(00C2)                    JMP 0xc200       ; jump to the os program
    78                                  
    79                                  error:
    80 000000AF BE[C700]                    MOV SI, msg
    81                                  putloop:
    82 000000B2 8A04                        MOV AL, [SI]
    83 000000B4 83C601                      ADD SI, 1
    84 000000B7 3C00                        CMP AL, 0    ; 終了判定
    85 000000B9 7409                        JE  fin
    86 000000BB B40E                        MOV AH, 0x0e ; 一文字表示
    87 000000BD BB0F00                      MOV BX, 15   ; カラーコード
    88 000000C0 CD10                        INT 0x10     ; ビデオBIOS呼び出し
    89 000000C2 EBEE                        JMP putloop
    90                                  
    91                                  fin:
    92 000000C4 F4                          HLT
    93 000000C5 EBFD                        JMP fin
    94                                  
    95                                  msg:
    96 000000C7 0A0A                        DB 0x0a, 0x0a   ; "\n\n"
    97 000000C9 6C6F6164206572726F-         DB "load error"
    97 000000D2 72                 
    98 000000D3 0A                          DB 0x0a         ; "\n"
    99 000000D4 00                          DB 0
   100                                  
   101 000000D5 00<rep 129h>                TIMES 0x1fe-($-$$) DB 0
   102 000001FE 55AA                        DB    0x55, 0xaa
